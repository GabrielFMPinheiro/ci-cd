name: Deploy to Staging

on:
  pull_request:
    types: [labeled, synchronize, reopened, closed]

permissions:
  pull-requests: write
  contents: write
  issues: write

jobs:
  deploy:
    if: github.event.pull_request.merged == false
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm install @actions/github@5.0.1 axios

      - name: Check if PR has using:staging label
        id: check-label
        run: |
          node -e "
            const github = require('@actions/github');
            const context = github.context;

            const labels = context.payload.pull_request.labels.map(label => label.name);
            if (labels.includes('using:staging')) {
              console.log('::set-output name=has_label::true');
            } else {
              console.log('::set-output name=has_label::false');
            }
          "