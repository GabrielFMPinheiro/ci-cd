name: Merge PRs with Staging Label

on:
  pull_request:
    types: [labeled, synchronize, reopened, closed]

permissions:
  pull-requests: write
  contents: write
  issues: write

jobs:
  merge-and-save:
    if: github.event.pull_request.merged == false
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm install @actions/github@5.0.1 axios

      - name: Check if PR has using:staging label
        id: check-label
        run: |
          node -e "
            const github = require('@actions/github');
            const context = github.context;

            const labels = context.payload.pull_request.labels.map(label => label.name);
            console.log('Labels on PR:', labels);
            if (labels.includes('using:staging')) {
              console.log('PR has using:staging label');
              console.log('::set-output name=has_label::true');
            } else {
              console.log('PR does not have using:staging label');
              console.log('::set-output name=has_label::false');
            }
          "

      - name: Merge and save if labeled
        if: steps.check-label.outputs.has_label == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Starting merge process"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          node << 'EOF'
            const { execSync } = require('child_process');
            const github = require('@actions/github');
            const axios = require('axios');

            (async () => {
              try {
                const context = github.context;
                const currentBranch = context.payload.pull_request.head.ref;

                // Fetch all PRs with the using:staging label
                console.log('Fetching PRs with using:staging label');
                const response = await axios.get(`https://api.github.com/repos/${{ github.repository }}/pulls`, {
                  headers: {
                    Authorization: `token ${process.env.GITHUB_TOKEN}`,
                    Accept: 'application/vnd.github.v3+json',
                  }
                });
                console.log('PRs fetched:', response.data);
                const prs = response.data.filter(pr => pr.labels.some(label => label.name === 'using:staging'));

                const successfulPRs = [];
                for (const pr of prs) {
                  if (pr.head.ref === currentBranch) {
                    console.log(`Skipping current PR #${pr.number}`);
                    continue;
                  }

                  console.log(`Fetching status checks for PR #${pr.number}`);
                  const statusResponse = await axios.get(`https://api.github.com/repos/${{ github.repository }}/commits/${pr.head.sha}/status`, {
                    headers: {
                      Authorization: `token ${process.env.GITHUB_TOKEN}`,
                      Accept: 'application/vnd.github.v3+json',
                    }
                  });
                  const statuses = statusResponse.data.statuses;
                  const failedChecks = statuses.filter(status => status.state !== 'success');
                  
                  if (failedChecks.length > 0) {
                    const failedChecksMessage = `The following status checks failed for PR #${pr.number}:\n` + failedChecks.map(check => `- ${check.context}: ${check.state}`).join('\n');
                    console.error(failedChecksMessage);
                    await axios.post(`https://api.github.com/repos/${{ github.repository }}/issues/${pr.number}/comments`, {
                      body: failedChecksMessage
                    }, {
                      headers: {
                        Authorization: `token ${process.env.GITHUB_TOKEN}`,
                        Accept: 'application/vnd.github.v3+json',
                      }
                    });
                  } else {
                    successfulPRs.push(pr);
                  }
                }

                // Fetch and merge successful PRs
                for (const pr of successfulPRs) {
                  console.log(`Fetching and merging PR #${pr.number}`);
                  execSync(`git fetch origin pull/${pr.number}/head:pr-${pr.number}`);
                  try {
                    execSync(`git merge pr-${pr.number} --no-commit --allow-unrelated-histories`);
                    console.log(`Merged PR #${pr.number}`);
                  } catch (err) {
                    console.error(`Conflict detected in PR #${pr.number}`, err);
                    const conflictMessage = `Conflict detected during merge with the following PRs:\n${err.message}`;
                    await axios.post(`https://api.github.com/repos/${{ github.repository }}/issues/${pr.number}/comments`, {
                      body: conflictMessage
                    }, {
                      headers: {
                        Authorization: `token ${process.env.GITHUB_TOKEN}`,
                        Accept: 'application/vnd.github.v3+json',
                      }
                    });
                    process.exit(1);
                  }
                }

                // Conclude the merge
                execSync('git commit -m "Merge all successful PRs with using:staging label"');
                console.log('Merge concluded successfully');

              } catch (error) {
                console.error('Error during merge process:', error);
                process.exit(1);
              }
            })();
          EOF
